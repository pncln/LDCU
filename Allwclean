#!/bin/sh
# Clean local LDCU turbulence library, solver, and tutorial artifacts

set -e

ROOT_DIR="$(cd "$(dirname "$0")" && pwd)"

# Load OpenFOAM environment if not already loaded
if [ -z "$WM_PROJECT_DIR" ] || [ ! -d "$WM_PROJECT_DIR" ]; then
    if [ -f "$HOME/OpenFOAM/OpenFOAM-v2406/etc/bashrc" ]; then
        . "$HOME/OpenFOAM/OpenFOAM-v2406/etc/bashrc"
    elif [ -f /opt/OpenFOAM/OpenFOAM-v2406/etc/bashrc ]; then
        . /opt/OpenFOAM/OpenFOAM-v2406/etc/bashrc
    elif [ -f /Volumes/OpenFOAM-v2406/etc/bashrc ]; then
        . /Volumes/OpenFOAM-v2406/etc/bashrc
    fi
fi

# Resolve wclean
if [ -n "$WM_PROJECT_DIR" ] && [ -x "$WM_PROJECT_DIR/wmake/wclean" ]; then
    WCLEAN="$WM_PROJECT_DIR/wmake/wclean"
else
    WCLEAN="$(command -v wclean || true)"
fi

echo "Cleaning ldcuTurbulence library…"
if [ -d "$ROOT_DIR/ldcuTurbulence" ] && [ -n "$WCLEAN" ]; then
    ( cd "$ROOT_DIR/ldcuTurbulence" && "$WCLEAN" libso ) || true
fi

echo "Cleaning rhoPimpleCentralFoam solver…"
if [ -d "$ROOT_DIR/rhoPimpleCentralFoam" ] && [ -n "$WCLEAN" ]; then
    ( cd "$ROOT_DIR/rhoPimpleCentralFoam" && "$WCLEAN" ) || true
fi

echo "Cleaning tutorial(s)…"
if [ -x "$ROOT_DIR/tutorials/aerofoilLDCU/Allclean" ]; then
    ( cd "$ROOT_DIR/tutorials/aerofoilLDCU" && ./Allclean ) || true
fi

# Remove installed artifacts from FOAM_USER_* locations
echo "Removing installed solver/lib from FOAM_USER directories…"
if [ -n "$FOAM_USER_APPBIN" ] && [ -d "$FOAM_USER_APPBIN" ]; then
    rm -f "$FOAM_USER_APPBIN/rhoPimpleCentralFoam" || true
fi
if [ -n "$FOAM_USER_LIBBIN" ] && [ -d "$FOAM_USER_LIBBIN" ]; then
    rm -f "$FOAM_USER_LIBBIN"/libldcuTurbulence.* || true
fi

echo "All clean."
